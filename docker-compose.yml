version: '3.7'
services:
  backend:
    image: node:14-alpine
    user: 'node'
    working_dir: /home/node/app
    environment:
      PORT: '3000'
      CAF_CERTIFICATE: '${CAF_CERTIFICATE}'
      CAF_PRIVATE_KEY: '${CAF_PRIVATE_KEY}'
      CAF_HOST: '${CAF_HOST}'
      DATABASE_URL: 'postgres://postgres:postgres@db:5432/postgres'
      REDIS_URL: 'redis://cache:6379'
      NODE_ENV: 'production'
      LOG_LEVEL: '1'
      SENTRY_DSN: 'https://public@sentry.example.com/1'
      ENV: 'test-real'
      SANDBOXED: 'false'
      SENTRY_ENABLED: 'false'
      MONITOR_QUALITY: 'false'
      PING_TOKEN: '${PING_TOKEN}'
      DATAPASS_API_KEY: 'lolilol'
      POLE_EMPLOI_TOKEN_URL: '${POLE_EMPLOI_TOKEN_URL}'
      POLE_EMPLOI_CLIENT_ID: '${POLE_EMPLOI_CLIENT_ID}'
      POLE_EMPLOI_CLIENT_SECRET: '${POLE_EMPLOI_CLIENT_SECRET}'
      POLE_EMPLOI_SCOPES: '${POLE_EMPLOI_SCOPES}'
      POLE_EMPLOI_API_URL: '${POLE_EMPLOI_API_URL}'
      SUPDATA_API_URL: '${SUPDATA_API_URL}'
      SUPDATA_INE_API_KEY: '${SUPDATA_INE_API_KEY}'
      SUPDATA_CIVILITE_API_KEY: '${SUPDATA_CIVILITE_API_KEY}'
      ISSUER_URL: '${ISSUER_URL}'
      BASE_URL: '${BASE_URL}'
      REDIRECT_URL: '${BASE_URL}/callback'
      CLIENT_ID: '${CLIENT_ID}'
      CLIENT_SECRET: '${CLIENT_SECRET}'
      SESSION_SECRET: 'yolo'
      ADMIN_USERS: '${ADMIN_USERS}'
    volumes:
      - ./:/home/node/app
    networks:
      - server-side
    ports:
      - 3000:3000
    command: 'npm start'
    depends_on:
      - cache
      - db

  cache:
    image: redis:6-alpine
    restart: always
    networks:
      - server-side

  db:
    image: timescale/timescaledb:latest-pg13
    restart: always
    environment:
      POSTGRES_PASSWORD: 'postgres'
    networks:
      - server-side

networks:
  server-side: {}
